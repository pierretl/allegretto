{% extends 'template/defaut.twig' %}

{% import 'macro.twig' as macro %}

{% block title %}Proposer un séjour{% endblock %}

{% block head %}
    {{ include('include/calendrier-config.twig') }}
{% endblock %}


{% block content %}

    <main id="contenu" class="grid-main" tabindex="-1" role="main">

        <div class="grid-main__full">
            <div class="cadre-m bg-neutral-000">
                
                {% if session.utilisateur.groupe == 'admin' %}
                    <div class="df ai-c jc-sb gap-m">
                        <h2 class="titre">Les séjours <span class="cadre-s bg-attente">en attente</span> ({{ sejoursAttente|length}})</h2>
                        <div>
                            <span class="exergue">Dernier rappel : {{ dernierRappel.0.date }}</span><br>
                            {% if get.rappel != "ok" %}
                                <form action="action/sejour-rappel.php" method="post">
                                    <button class="btn-2 btn-s" type="submit">Envoyer un mail de rappel</button>
                                </form>
                            {% endif %}
                            {% if get.rappel == "ko" %}
                                <span class="label-erreur">
                                    L'envoi de l'email n'a pas abouti
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <h2 class="titre">Les séjours <span class="cadre-s bg-attente">en attente</span> ({{ sejoursAttente|length}})</h2>               
                {% endif %}

                <div class="scroll">
                    <table class="tableau">
                        <caption></caption>
                        <thead>
                            <tr>
                                <td>Séjour</td>
                                {% for famille in sejours.0.validation %}
                                    <td>
                                        {{ getLabelFamille(famille.id) }}
                                    </td>
                                {% endfor %}
                                {% if session.utilisateur.groupe == 'admin' %}
                                    <td>
                                        Admin
                                    </td>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in sejours %}
                                {% set sejourKey = loop.index %}

                                {% if item.backgroundColor == getenv('CALENDRIER_COLOR-VALIDE') %}
                                    {% set masque = ' style=display:none' %}
                                {% else %}
                                    {% set masque = '' %}
                                {% endif %}
                                <tr{{masque}}>
                                    <td>
                                        {% if (strLength(item.title) > 20) %}
                                            <button type="button" onclick="afficheLaSuite(this)" aria-expanded="false" class="btn-3">
                                                {{ subString(item.title, 0, 20) }}<span class="expanded-reverse">...</span>
                                                <span class="expanded mt-0 mb-0">
                                                    {{ subString(item.title, 20) }}
                                                </span>
                                            </button>
                                        {% else %}
                                            {{ item.title }}
                                        {% endif %}

                                        {% if (item.commentaire) %}
                                            <button type="button" onclick="afficheLaSuite(this)" aria-expanded="false" class="btn-3">
                                                <svg width="20px" height="20px" class="expanded" style="margin-left:.2rem">
                                                    <use xlink:href="#fermer"></use>
                                                </svg>
                                                <svg width="20px" height="20px" class="expanded-reverse" style="margin-left:.2rem">
                                                    <use xlink:href="#bulle"></use>
                                                </svg>
                                            </button>
                                            <span class="expanded-sibling">
                                                <br>{{ item.commentaire }}
                                            </span>
                                        {% endif %}

                                        <span class="text-7">
                                            {% if (item.start == item.departReel) %}
                                                <br>La journée du {{ item.start | date("d/m/Y") }}
                                            {% else %}
                                                <br>{{ item.start | date("d/m/Y") }}&nbsp;&#10140;&nbsp;{{ item.departReel | date("d/m/Y") }}
                                            {% endif %}
                                        </span>
                                    </td>
                                    {% for famille in item.validation %}
                                        <td>
                                            {% if famille.accord %}

                                                {% if item.dataAjout == famille.accord %}
                                                    {% if famille.id == session.utilisateur.famille %}

                                                        {% if "now" | date('U') < item.start | date('U') %}
                                                            {% include 'include/supprimer-sejour.twig' %}
                                                        {% else %}
                                                            <span class="exergue" title="Demande du {{ famille.accord | date("d/m/Y \\à H\\hi", "Europe/Paris") }}">
                                                                Demandeur
                                                            </span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="exergue" title="Demande du {{ famille.accord | date("d/m/Y \\à H\\hi", "Europe/Paris") }}">
                                                            Demandeur
                                                        </span>
                                                    {% endif %}
                                                {% else %}
                                                    <div class="df ai-c">
                                                        <svg width="24px" height="24px" class="fill-8">
                                                            <use xlink:href="#check"></use>
                                                        </svg>
                                                        <span title="le {{ famille.accord | date("d/m/Y \\à H\\hi", "Europe/Paris") }}">
                                                            Validé
                                                        </span>
                                                    </div>
                                                {% endif %}
                                                
                                            {% else %}

                                                {% if item.backgroundColor == getenv('CALENDRIER_COLOR-VALIDE') %}

                                                    <p>Séjour validé avant l'ajout de la famille</p>
                                                    
                                                {% else %}

                                                    {% if famille.id == session.utilisateur.famille %}
                                                        <form action="action/sejour-validation.php?key={{ sejourKey }}" method="post">
                                                            <button type="submit" class="btn-1 v_petit">Je&nbsp;valide&nbsp;!</button>
                                                        </form>  
                                                    {% else %}
                                                        <span>En&nbsp;attente...</span>
                                                    {% endif %}
                                                    
                                                {% endif %}

                                                
                                                    
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                {% if session.utilisateur.groupe == 'admin' %}
                                    <td>
                                        {% include 'include/supprimer-sejour.twig' %}
                                    </td>
                                {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="grid-main__tiers1">
            <div class="cadre-m bg-neutral-000 df fd-c gap-m">
                <h2 class="titre">Les séjours <span class="cadre-s bg-valide">validés</span> ({{ sejoursValide|length}})</h2>
                <div class="scroll">
                    <table class="tableau">
                        <caption></caption>
                        <thead>
                            <tr>
                                <td>Label & commentaire</td>
                                <td>Arrivée</td>
                                <td>Départ</td>
                                <td>Séjour validé<br>avant l'ajout de</td>
                                {% if session.utilisateur.groupe == 'admin' %}
                                    <td>
                                        Supprimer
                                    </td>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in sejoursValide %}
                                {% set sejourKey = loop.index %}
                                <tr>
                                    <td>
                                        {% if (strLength(item.title) > 20) %}
                                            <button type="button" onclick="afficheLaSuite(this)" aria-expanded="false" class="">
                                                {{ subString(item.title, 0, 20) }}<span class="expanded-reverse">...</span>
                                                <span class="expanded mt-0 mb-0">
                                                    {{ subString(item.title, 20) }}
                                                </span>
                                            </button>
                                        {% else %}
                                            {{ item.title }}
                                        {% endif %}

                                        {% if (item.commentaire) %}
                                            <button type="button" onclick="afficheLaSuite(this)" aria-expanded="false" class="btn-3">
                                                <svg width="20px" height="20px" class="fill-3 expanded" style="margin-left:.2rem">
                                                    <use xlink:href="#fermer"></use>
                                                </svg>
                                                <svg width="20px" height="20px" class="fill-3 expanded-reverse" style="margin-left:.2rem">
                                                    <use xlink:href="#bulle"></use>
                                                </svg>
                                            </button>
                                            <span class="expanded-sibling">
                                                <br>{{ item.commentaire }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.start | date("d/m/Y") }}</td>
                                    <td>{{ item.departReel | date("d/m/Y") }}</td>
                                    <td>
                                        {% for famille in item.validation %}
                                            {% if (famille.accord == '') and (item.backgroundColor == getenv('CALENDRIER_COLOR-VALIDE')) %}
                                            {{famille.accord}}
                                                {{getLabelFamille(famille.id)}}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    
                                {% if session.utilisateur.groupe == 'admin' %}
                                    <td>
                                        <button type="button" class="btn-2 v_petit" onclick="suppressionSejour({{ sejourKey }})">Supprimer</button>
                                        <dialog id="suppressionSejour-{{ sejourKey }}" class="modal">
                                            <form action="action/sejour-suppression.php?key={{ loop.index }}" method="post">
                                                <h3>Etes-vous sûr de vouloir continuer ?</h3>
                                                <p>
                                                    Séjour : {{ item.title }}<br>
                                                    du <strong>{{ item.start | date("d/m/Y") }}</strong> au <strong>{{ item.departReel | date("d/m/Y") }}</strong>
                                                    {% if item.commentaire %}
                                                    <br> {{ item.commentaire }}
                                                    {% endif %}
                                                </p>
                                                <div class="df">
                                                    <div>
                                                        <button class="btn-1 v_petit" type="button" onclick="fermeModal({{ sejourKey }})">Annuler</button>
                                                    </div>
                                                    <div>
                                                        <button class="btn-1 v_petit" type="submit">Supprimer ce séjour</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </dialog>
                                    </td>
                                {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                

            </div>
        </div>

        <div class="grid-main__tiers2">
            <div class="cadre-m bg-neutral-000 df fd-c gap-m">
                <h2 class="titre">Le calendrier</h2>
                <div class="fc-surcharge">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

    </main>

    <script>
        function suppressionSejour(key) {
            document.getElementById('suppressionSejour-'+key).showModal();
        }
        function fermeModal(key) {
            document.getElementById('suppressionSejour-'+key).close();
        }
        function afficheLaSuite(e) {
            if (e.getAttribute("aria-expanded") === "false") {
                e.setAttribute("aria-expanded", "true");
            } else {
                e.setAttribute("aria-expanded", "false");
            }
        }
    </script>

{% endblock %}